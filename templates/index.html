<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Boat Room Availability</title>
	<link rel="stylesheet" href="/static/styles.css" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker.min.css" integrity="sha512-34s5cpvaNG3BknEWSuOncX28vz97bRI59UnVtEEpFX536A7BtZSJHsDyFoCl8S7Dt2TPzcrCEoHBGeM4SUBDBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
	<div class="container py-4">
		<h1 class="mb-4">Boat Room Availability</h1>
		<form id="search-form" class="mb-4">
			<div class="row">
				<div class="col-sm-3">
					<label class="form-label">Start Date</label>
					<input type="text" id="start" class="form-control" required />
				</div>
				<div class="col-sm-3">
					<label class="form-label">End Date</label>
					<input type="text" id="end" class="form-control" required />
				</div>
				<div class="col-sm-4">
					<label class="form-label">Boat</label>
					<select id="boat" class="form-select">
						<option value="">All boats</option>
					</select>
				</div>
				<div class="col-sm-2">
					<label class="form-label">&nbsp;</label>
					<div>
						<button type="submit" class="btn btn-primary w-100">Search</button>
					</div>
				</div>	
			</div>
		</form>

		<div class="table-responsive">
			<table id="results" class="table table-striped table-hover">
			<thead>
				<tr>
					<th>Start Date</th>
					<th>Boat name</th>
					<th>Room name</th>
					<th>Room Link</th>
				</tr>
			</thead>
			<tbody></tbody>
			</table>
		</div>
	</div>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
	<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js" integrity="sha512-LsnSViqQyaXpD4mBBdRYeP6sRwJiJveh2ZIbW41EBrNmKxgr/LFZIiWT6yr+nycvhvauz8c2nYMhrP80YhG7Cw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script>
		const form = document.getElementById('search-form');
		const tbody = document.querySelector('#results tbody');
		const boatSel = document.getElementById('boat');
		let dataTable;

		function fmt(d){ return d; }

		// Populate boats selector
		async function loadBoats(){
			const res = await fetch('/boats');
			if(!res.ok) return;
			const boats = await res.json();
			for(const b of boats){
				const opt = document.createElement('option');
				opt.value = b.name;
				opt.textContent = b.name;
				boatSel.appendChild(opt);
			}
		}
		loadBoats();

		// Init Bootstrap Datepicker (yyyy/mm/dd)
		$('#start, #end').datepicker({
			format: 'yyyy/mm/dd',
			autoclose: true,
			todayHighlight: true
		});

		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			// Initialize or refresh DataTable
			if(dataTable){
				dataTable.clear().destroy();
			}

			tbody.innerHTML = '';
			const start = document.getElementById('start').value;
			const end = document.getElementById('end').value;
			const boat = boatSel.value;
			if(!start || !end) return;
			// Show loader below table
			const loader = document.createElement('div');
			loader.className = 'text-center my-3';
			loader.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
			document.querySelector('.table-responsive').after(loader);
			const payload = { start: fmt(start), end: fmt(end) };
			if(boat) payload.boat = boat;
			const res = await fetch(`/availability`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			});
			if(!res.ok){ alert('Failed to fetch availability'); return; }
			const data = await res.json();
			console.log(data);

			for(const row of data){
				const tr = document.createElement('tr');
				const boatCell = row.boat_link ? `<a href="${row.boat_link}" target="_blank">${row.boat_name}</a>` : row.boat_name;
				const roomCell = row.room_link ? `<a href="${row.room_link}" target="_blank">${row.room_name}</a>` : row.room_name;
				const roomLinkCell = row.room_link ? `<a href="${row.room_link}" target="_blank">${row.room_link}</a>` : '';
				tr.innerHTML = `
					<td>${row.start}</td>
					<td>${boatCell}</td>
					<td>${roomCell}</td>
					<td>${roomLinkCell}</td>
				`;
				tbody.appendChild(tr);
			}

			dataTable = new $.fn.dataTable.Api($('#results').DataTable({
				order: [[0, 'asc']],
				pageLength: 25,
				lengthMenu: [10, 25, 50, 100],
			}));
			loader.remove();
		});
	</script>
</body>
</html>
